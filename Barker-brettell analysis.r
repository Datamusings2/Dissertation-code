################################################################################################ set  up the environment ##################################################################################################################################################################################################### May 2021 - current file to look at efficiency trend within BB data#############################################################################library(forcats)library(tidyverse)library(RedditExtractoR)library(dplyr)library(ggplot2)library(tidytext)library(lubridate)library(zoo)library(fpp2)library(viridis)#clean environmentrm(list=ls())# import all of the CSV files and combine into a single data frame# save dataframe as CSVsetwd("~/OneDrive/im906 - dissertation/Firm data/Original CSV")############################################################################### This section merges all of the files - DO NOT RUN IF YOU DO NOT NEED TO#filenames <- list.files(full.names=TRUE)#All <- lapply(filenames,function(i){#  read.csv(i, sep = ",")#})#time_data <- do.call(rbind.data.frame, All)#head(time_data)#tail(time_data)#write.csv(time_data,"all_time.csv", row.names=FALSE)#######################################################################time_data <- read.csv("all_time.csv", sep = ",")test_data <- read.csv("2006-7.csv", sep = ",")########################################################################################### check variables and make sure numeric, etc #################################################################################################class(time_data)# make units numericclass(time_data$Unit...Total..as.Minutes)time_data$Unit...Total..as.Minutes <- as.numeric(as.character(time_data$Unit...Total..as.Minutes))class(time_data$Unit...Total..as.Minutes)# make date a datetime_data$date <- as.Date(substr(time_data$Start.Date...Time, 1, 10), format="%d/%m/%Y") #take the date only and make a new vector in dataframe class(time_data$Unit...Total..as.Minutes)class(time_data$date)############################################################################################### look at the df and polish  #####################################################################################################################nrow(time_data)   #1.5 million rows...colnames(time_data) #what are the variable names?colnames (time_data) <- c("create_date","date_posted","user_code", "comments", "rate", "booking_code", "units", "case_type", "law_code", "country", "law_name", "date") #make the names nicercolnames(time_data) #what are the variable names?str(time_data)############################################################################################## need to generate weekly totals  ############################################################################################################################################################################################################ work out how many fee earners per day ########################################################################################################fee_per_day <- with (time_data, tapply (user_code, date, FUN = function (x) length(unique(x)))) #total fee earners per dayfee_per_day <- as.data.frame(fee_per_day)typeof(fee_per_day)head (fee_per_day)class(fee_per_day)fee_per_day$date <- as.Date(row.names(fee_per_day)) # Need to convert index of dataframe to a column so that ggplot can handle it :-(head (fee_per_day)ggplot (data <- fee_per_day, aes(x = date, y=fee_per_day, group = 1)) +   #This graph is very dirty - lots of low numbers due to the weekends, but gives a great trend.   geom_point()head(time_data)tail (time_data)################################################################################################ play with totals of data ######################################################################################################################################################################################################## DO NOT USE THE FOLLOWING IF PROCESSING ALL OF THE DATA ##################################################################################################test_data$date <- as.Date(substr(test_data$Start.Date...Time, 1, 10), format="%d/%m/%Y") #take the date only and make a new vector in dataframe colnames (test_data) <- c("create_date","date_posted","user_code", "comments", "rate", "booking_code", "units", "case_type", "law_code", "country", "law_name", "date") #make the names nicerhead (test_data)nrow(test_data)# Summarise each charge code over each daytest_data %>%  group_by(date, booking_code) %>%   summarise(Total = sum(units, na.rm = TRUE))# Summarise each fee earner over each day and per booking codefirst_trial <- test_data %>%  group_by(date, user_code, booking_code) %>%   summarise(Total = sum(units, na.rm = TRUE))first_trial <- data.frame(first_trial)head(first_trial)class(first_trial)### restrict down to user 12 and CHAfe_12 <- filter(first_trial, (first_trial$user_code == 12) & (booking_code == 'CHA'))head(fe_12)ggplot (data <- fe_12, aes(x = date, y=Total, group = 1)) +     geom_point()  ##### more playinghead(first_trial)#### total time recorded....head(test_data)total_recorded <- test_data %>%  group_by(date, user_code) %>%   summarise(Total = sum(units, na.rm = TRUE))head(total_recorded)total_recorded <- data.frame(total_recorded)## The following is quite a cool graph - the mean amount of time recorded can clearly be seen through the plot.ggplot (data <- total_recorded, aes(x = date, y=Total, group = 1)) +     geom_point() +  geom_smooth(method = "lm") ## The following looks a bit weird and then you realise that there is a column for each user.ggplot (data <- total_recorded, aes(x = user_code, y=Total, group = 1)) +     geom_point()## What about sorting out to split patent from tmpatent_trial <- data.frame(test_data %>%  group_by(date, case_type) %>%   summarise(Total = sum(units, na.rm = TRUE)))head(patent_trial)class(patent_trial)patent_trial <- filter(patent_trial, (patent_trial$case_type == 'P') | (patent_trial$case_type == 'T'))head(patent_trial)############################################################################################### start building a data frame for fee earners ##########################################################################################################fee_earners <- data.frame(unique(test_data$user_code)) # how many unique fee earners are therecolnames(fee_earners) <- c("user_code")class(fee_earners)length(fee_earners$user_code) #- 49 fee earners (2006 - 2007)fee_earnersfee_earners <- data.frame(fee_earners[order(fee_earners$user_code),])class(fee_earners)colnames(fee_earners) <- c("user_code")fee_earners    #now fee earners is ordered## start adding some meaning data to df.## total units recorded for the year.head(test_data)total_recorded <- data.frame(test_data %>%  group_by(user_code) %>%   summarise(Total = sum(units, na.rm = TRUE)))total_recordedtotal_recorded <- data.frame(total_recorded)fee_earners <- cbind (fee_earners, Total = total_recorded$Total)colnames(fee_earners) <- c("user_code", "Total")fee_earners## total CHA units recorded for the year.head(test_data)book_CHA <- filter(test_data, (test_data$booking_code == 'CHA'))head(book_CHA)CHA_recorded <- data.frame(book_CHA %>%                               group_by(user_code) %>%                                summarise(Total_CHA = sum(units, na.rm = TRUE)))head(CHA_recorded)fee_earnersCHA_recorded#oops - some fee earners did not record any CHA so need to add zero's into the data for themCHA_recorded <- rbind(CHA_recorded[1:34,],0,CHA_recorded[-(1:34),])rownames(CHA_recorded) <- NULLCHA_recorded <- rbind(CHA_recorded[1:45,],0,CHA_recorded[-(1:45),])fee_earners <- cbind (fee_earners, Total_CHA = CHA_recorded$Total_CHA)colnames(fee_earners) <- c("user_code", "Total", "Total_CHA")head(fee_earners)## total PRODDUCTIVE (CHA / CHS / DRA ) units recorded for the year.unique (test_data$booking_code) #what are the unique booking codes that have been used.head(test_data)book_productive <- filter(test_data, (test_data$booking_code == 'CHA') | (test_data$booking_code == 'CHS') | (test_data$booking_code == 'DRA'))head(book_productive)productive_recorded <- data.frame(book_productive %>%                             group_by(user_code) %>%                              summarise(Total_productive = sum(units, na.rm = TRUE)))head(productive_recorded)fee_earnersproductive_recorded#oops - some fee earners did not record any CHA so need to add zero's into the data for them - 38 is missing...productive_recorded <- rbind(productive_recorded[1:34,],0,productive_recorded[-(1:34),])rownames(productive_recorded) <- NULLfee_earners <- cbind (fee_earners, Total_productive = productive_recorded$Total_productive)head(fee_earners)### How much marketing do they do ?? Might be useful to track over time and see how CHA moves...unique (test_data$booking_code) #what are the unique booking codes that have been used.head(test_data)book_marketing <- filter(test_data, (test_data$booking_code == 'MKT'))head(book_marketing)marketing_recorded <- data.frame(book_marketing %>%                                    group_by(user_code) %>%                                     summarise(Total_marketing = sum(units, na.rm = TRUE)))head(marketing_recorded)fee_earnersmarketing_recorded#oops - some fee earners did not record any MKT so need to add zero's into the data for themmarketing_recorded <- rbind(marketing_recorded[1:1,],0,marketing_recorded[-(1:1),])rownames(marketing_recorded) <- NULLmarketing_recorded <- rbind(marketing_recorded[1:10,],0,marketing_recorded[-(1:10),])rownames(marketing_recorded) <- NULLmarketing_recorded <- rbind(marketing_recorded[1:23,],0,marketing_recorded[-(1:23),])rownames(marketing_recorded) <- NULLmarketing_recorded <- rbind(marketing_recorded[1:31,],0,marketing_recorded[-(1:31),])rownames(marketing_recorded) <- NULLmarketing_recorded <- rbind(marketing_recorded[1:34,],0,marketing_recorded[-(1:34),])rownames(marketing_recorded) <- NULLfee_earners <- cbind (fee_earners, Total_marketing = marketing_recorded$Total_marketing)fee_earners######### Are they Patent or TM guys??head(test_data)patent_trial <- test_datapatent_trial <- filter(patent_trial, (patent_trial$case_type == 'T') | (patent_trial$case_type == 'P'))head(patent_trial, n=50)patent_trial <- patent_trial %>%  group_by(case_type, user_code, booking_code) %>%   summarise(Total = sum(units, na.rm = TRUE))patent_trial <- data.frame(patent_trial)tail(patent_trial, n=100)patent_trial <- patent_trial %>%  group_by(user_code, case_type) %>%   summarise(Total = sum(Total, na.rm = TRUE)) patent_trial <- data.frame(patent_trial)patent_trialfee_earners$total_patent_time <- as.numeric(c(21770,60,31044,0,27636,39476,30522,29190,0,0,202,12507,12948,18988,0,0,19590,19032,12014,0,29266,0,26940,37814,28413,27061,16076,28314,18401,32352,27685,112,21023,26494,30,19439,19168,34554,0,0,0,36960,28404,22754,0,6720,0,38049,0))fee_earnersfee_earners$total_tm_time <- as.numeric(c(0,0,0,7554,0,0,0,3036,24123,41940,0,0,0,0,13127,10947,0,1290,0,3192,0,6795,0,0,0,0,0,1547,0,0,0,0,0,0,0,0,990,0,14504,15753,2700,0,0,0,4259,0,21996,0,4644))fee_earnersfee_earners$pat_or_tm <- vector (mode = 'character', length = 49)## fill the column of dataframe with P or T according to whether predominanlty patent or tmfor (i in 1:length(fee_earners$total_patent_time)){    if (fee_earners$total_patent_time[i] > fee_earners$total_tm_time[i]){    fee_earners$pat_or_tm[i] <- 'P'    } else  {    fee_earners$pat_or_tm[i] <- 'T'  }}fee_earners### add efficiency of fee earner - (total_productive / total ) * 100fee_earners$effiency <- round((fee_earners$Total_productive / fee_earners$Total) * 100)fee_earners### try some graphs before clusteringggplot (data <- fee_earners, aes(x = Total, y= effiency, group = 1)) +     geom_point() +  geom_smooth(method = "lm") +  ggtitle("Total time recorded vs. efficiency")ggplot (data <- fee_earners, aes(x = Total_marketing, y= Total_productive, color = pat_or_tm)) +     geom_point() +  geom_smooth(method = "lm") +  ggtitle("Total marketing vs. total productive")################################################################################# Clustering################################################################################data_train <- fee_earners[, which (names(fee_earners) != "pat_or_tm")]data_train## Have a go with 3 clusters  --- https://blog.dominodatalab.com/clustering-in-r/set.seed(278613)cluster <- kmeans(x=data_train, centers=3)clusterinstall.packages("useful")library(useful)plot(cluster, data= data_train)plot(cluster, data=fee_earners, class="pat_or_tm")## run plot to see how many clusters would be bestfeeBest <- FitKMeans(data_train, max.clusters = 20, nstart = 25, seed = 278613)PlotHartigan(feeBest)## redo with 4 clusters as suggested by Hartigancluster2 <- kmeans(x=data_train, centers=4)cluster2plot(cluster2, data= data_train)plot(cluster2, data=fee_earners, class="pat_or_tm")### This doesn't really tie up to the tm or patent split...############################################################################################################################################################################################################################################# Repeat with the whole data set rather than just the test data set############################################################################################################################################################################################################################################time_data <- read.csv("all_time.csv", sep = ",")  ## Read in the data if you want it again.######## Tidy up the variablesclass(time_data)# make units numericclass(time_data$Unit...Total..as.Minutes)time_data$Unit...Total..as.Minutes <- as.numeric(as.character(time_data$Unit...Total..as.Minutes))class(time_data$Unit...Total..as.Minutes)# make date a datetime_data$date <- as.Date(substr(time_data$Start.Date...Time, 1, 10), format="%d/%m/%Y") #take the date only and make a new vector in dataframe class(time_data$Unit...Total..as.Minutes)class(time_data$date)### make the column names prettycolnames (time_data) <- c("create_date","date_posted","user_code", "comments", "rate", "booking_code", "units", "case_type", "law_code", "country", "law_name", "date") #make the names nicerhead (time_data)nrow(time_data)### Now work out number of fee earners per day...fee_per_day <- with (time_data, tapply (user_code, date, FUN = function (x) length(unique(x)))) #fee earners per dayfee_per_daytypeof(fee_per_day)head (fee_per_day)class(fee_per_day)nrow(fee_per_day)### Make it a tibblefee_per_day_frame <- as.data.frame.table(fee_per_day)head (fee_per_day_frame)fee_per_day_tib <- as_tibble(fee_per_day_frame)head(fee_per_day_tib)fee_per_day_tibtail(fee_per_day_tib)### quickly drop it into a time series and see what happensY <- ts (fee_per_day_tib [,2], start = c(2005,44), frequency = 52)autoplot(Y)### works ok but the drop of fee earners at the weekends is causing problems on how it looks.################################################################################################# cha per day #################################################################################################################################chargeable <- filter(time_data, (time_data$booking_code == "CHA" | time_data$booking_code == "DRC" | time_data$booking_code == "CHS" | time_data$booking_code == "DRA"))chargeablehead(chargeable)tail(chargeable)class(chargeable$units)cha_per_day <- with (chargeable, tapply (units, date, sum))head (cha_per_day)class(cha_per_day)cha_per_day_frame <- as.data.frame.table(cha_per_day)head (cha_per_day_frame)colnames (cha_per_day_frame) <- c("date","total_cha")head (cha_per_day_frame)nrow(cha_per_day_frame)################################################################################################ Non - cha per day ###########################################################################################################################non_chargeable <- filter(time_data, time_data$booking_code != "CHA") #remove CHAnon_chargeablenrow(non_chargeable)non_chargeable <- filter(non_chargeable, non_chargeable$booking_code != "HOL") #remove HOLnon_chargeable <- filter(non_chargeable, non_chargeable$booking_code != "DRC") #remove DRCnon_chargeable <- filter(non_chargeable, non_chargeable$booking_code != "CHS") #remove CHSnon_chargeable <- filter(non_chargeable, non_chargeable$booking_code != "DRA") #remove DRAhead(non_chargeable)class(non_chargeable)non_chargeablenon_cha_per_day <- with (non_chargeable, tapply (units, date, sum))head (non_cha_per_day)class(non_cha_per_day)non_cha_per_day_frame <- as.data.frame.table(non_cha_per_day)head (non_cha_per_day_frame)colnames (non_cha_per_day_frame) <- c("date","total_non_cha")head (non_cha_per_day_frame)nrow(non_cha_per_day_frame) #note here that there may be weekends (or other days) where fee earners have recorded only non chargeable time and so there will not be, necessarily, the same number of rows of data in chargeable and non-chargeable. Need two separate data frames at this point and merge as we do the weekly totals.############################################################################################ add days of the week to the data frames #####################################################################################################head (cha_per_day_frame)cha_per_day_frame$days <- weekdays(as.Date(cha_per_day_frame$date))head (cha_per_day_frame)head (non_cha_per_day_frame)non_cha_per_day_frame$days <- weekdays(as.Date(non_cha_per_day_frame$date))head (non_cha_per_day_frame)head (fee_per_day_frame)fee_per_day_frame$days <- weekdays(as.Date(fee_per_day_frame$Var1))colnames (fee_per_day_frame) <- c("date","no_fee_earners", "days")head (fee_per_day_frame)nrow(fee_per_day_frame)########################################################################################## Initial graphs before too much processing #################################################################################################ggplot (data <- cha_per_day_frame, aes(x = date, y=total_cha, group = 1)) +   #This graph is very dirty - lots of low numbers due to the weekends, but gives a great trend.   geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Recorded chargeable time - hours")+  ggtitle("Total Recorded Time by All Fee-Earners")############################################################################################### weekly totals needed #######################################################################################################################weekly_total <- data.frame("date" = as.Date(rep(0,750), origin = "1900-01-01"), "seven_minutes_cha" = numeric (750),"five_minutes_cha" = numeric(750),"seven_minutes_non" = numeric (750),"five_minutes_non" = numeric(750), "min_per_fee" = numeric(750), "week_day_fee" = numeric(750), "week_end_fee" = numeric(750))head (weekly_total)#################################### CHA #######################################tail (cha_per_day_frame)cha_per_day_framehead (cha_per_day_frame) #this frame has total Chanrow(cha_per_day_frame)count <- nrow(cha_per_day_frame)no_days <- countcountno_daysseven_total_cha <- 0five_total_cha <- 0week_no <- 1#no_days <- 30#count <- 30while(count > 2){         #count is in days    # This block is triggered if the day is a Monday  if (cha_per_day_frame$days[no_days-count+1] != "Saturday" && cha_per_day_frame$days[no_days-count+1] != "Sunday"){    five_total_cha <- five_total_cha + cha_per_day_frame$total_cha[no_days-count+1]    seven_total_cha <- seven_total_cha + cha_per_day_frame$total_cha[no_days-count+1]            #print (count)    #print (week_day_total)    #print (fee_per_day_frame$days[no_days-count+1])  }    count <- count-1    while (cha_per_day_frame$days[no_days-count+1] != "Monday"){        if (cha_per_day_frame$days[no_days-count+1] != "Saturday" && cha_per_day_frame$days[no_days-count+1] != "Sunday"){      five_total_cha <- five_total_cha + cha_per_day_frame$total_cha[no_days-count+1]      seven_total_cha <- seven_total_cha + cha_per_day_frame$total_cha[no_days-count+1]            #print (count)      #print (week_day_total)      #print (fee_per_day_frame$days[no_days-count+1])      #print (fee_earners)    }        if (cha_per_day_frame$days[no_days-count+1] == "Saturday" || cha_per_day_frame$days[no_days-count+1] == "Sunday"){      seven_total_cha <- seven_total_cha + cha_per_day_frame$total_cha[no_days-count+1]    }        count <- count - 1      }    #print (fee_per_day_frame$days[no_days-count+1])  #print (count)  #print (week_day_total)  weekly_total$date[week_no] <- as.Date(cha_per_day_frame$date[no_days-count+1], format = "%Y-%m-%d")  weekly_total$date[week_no] <- weekly_total$date[week_no] - 7 #correct it to be the week before  #print (as.Date(fee_per_day_frame$date[no_days-count+1]))  weekly_total$five_minutes_cha[week_no] <- five_total_cha  weekly_total$seven_minutes_cha[week_no] <- seven_total_cha  #print("week")  #print(weekly_total$week_day_fee[week_no])    seven_total_cha <- 0  five_total_cha <- 0  week_no <- week_no + 1  }countweek_nohead(weekly_total)tail (weekly_total)weekly_totalclass(weekly_total)tail(weekly_total)#################################### Fee ######################################## Now work out the number of fee earners in each day.tail (fee_per_day_frame)fee_per_day_framehead (fee_per_day_frame) #this frame has number of fee earners per daynrow(fee_per_day_frame)count <- nrow(fee_per_day_frame)no_days <- countfee_earners_week <- 0fee_earners_end <- 0countno_dayshead (weekly_total)week_no <- 1#no_days <- 30#count <- 30while(count > 2){         #count is in days    # This block is triggered if the day is a Monday  if (fee_per_day_frame$days[no_days-count+1] != "Saturday" && fee_per_day_frame$days[no_days-count+1] != "Sunday"){    fee_earners_week <- fee_earners_week + fee_per_day_frame$no_fee[no_days-count+1]            #print (count)    #print (week_day_total)    #print (fee_per_day_frame$days[no_days-count+1])  }    count <- count-1    while (fee_per_day_frame$days[no_days-count+1] != "Monday"){        if (fee_per_day_frame$days[no_days-count+1] != "Saturday" && fee_per_day_frame$days[no_days-count+1] != "Sunday"){      fee_earners_week <- fee_earners_week + fee_per_day_frame$no_fee[no_days-count+1]                  #print (count)      #print (week_day_total)      #print (fee_per_day_frame$days[no_days-count+1])      #print (fee_earners)    }        if (fee_per_day_frame$days[no_days-count+1] == "Saturday" || fee_per_day_frame$days[no_days-count+1] == "Sunday"){      fee_earners_end <- fee_earners_end + fee_per_day_frame$no_fee[no_days - count + 1]    }        count <- count - 1      }    #print (fee_per_day_frame$days[no_days-count+1])  #print (count)  #print (week_day_total)  #weekly_total$date[week_no] <- as.Date(fee_per_day_frame$date[no_days-count+1], format = "%Y-%m-%d")  #weekly_total$date[week_no] <- weekly_total$date[week_no] - 7 #correct it to be the week before  #print (as.Date(fee_per_day_frame$date[no_days-count+1]))    weekly_total$week_day_fee[week_no] <- fee_earners_week/5  weekly_total$week_end_fee[week_no] <- fee_earners_end/2    #print("week")  #print(weekly_total$week_day_fee[week_no])    fee_earners_week <- 0  fee_earners_end <- 0  week_no <- week_no + 1  }countweek_nohead(weekly_total)weekly_totalclass(weekly_total)tail(weekly_total)#################################### Non ######################################## now calculate the non-chargeable timetail (non_cha_per_day_frame)non_cha_per_day_framehead (non_cha_per_day_frame) #this frame has total non_chargeablenrow(non_cha_per_day_frame)count <- nrow(non_cha_per_day_frame)no_days <- countcountno_daysseven_total_non <- 0five_total_non <- 0week_no <- 1#no_days <- 30#count <- 30while(count > 2){         #count is in days    # This block is triggered if the day is a Monday  if (non_cha_per_day_frame$days[no_days-count+1] != "Saturday" && non_cha_per_day_frame$days[no_days-count+1] != "Sunday"){    five_total_non <- five_total_non + non_cha_per_day_frame$total_non_cha[no_days-count+1]    seven_total_non <- seven_total_non + non_cha_per_day_frame$total_non_cha[no_days-count+1]            #print (count)    #print (week_day_total)    #print (fee_per_day_frame$days[no_days-count+1])  }    count <- count-1    while (non_cha_per_day_frame$days[no_days-count+1] != "Monday"){        if (non_cha_per_day_frame$days[no_days-count+1] != "Saturday" && non_cha_per_day_frame$days[no_days-count+1] != "Sunday"){      five_total_non <- five_total_non + non_cha_per_day_frame$total_non_cha[no_days-count+1]      seven_total_non <- seven_total_non + non_cha_per_day_frame$total_non_cha[no_days-count+1]            #print (count)      #print (week_day_total)      #print (fee_per_day_frame$days[no_days-count+1])      #print (fee_earners)    }        if (non_cha_per_day_frame$days[no_days-count+1] == "Saturday" || non_cha_per_day_frame$days[no_days-count+1] == "Sunday"){      seven_total_non <- seven_total_non + non_cha_per_day_frame$total_non_cha[no_days-count+1]    }        count <- count - 1      }    #print (fee_per_day_frame$days[no_days-count+1])  #print (count)  #print (week_day_total)  #weekly_total$date[week_no] <- as.Date(cha_per_day_frame$date[no_days-count+1], format = "%Y-%m-%d")  #weekly_total$date[week_no] <- weekly_total$date[week_no] - 7 #correct it to be the week before  #print (as.Date(fee_per_day_frame$date[no_days-count+1]))  weekly_total$five_minutes_non[week_no] <- five_total_non  weekly_total$seven_minutes_non[week_no] <- seven_total_non  #print("week")  #print(weekly_total$week_day_fee[week_no])    seven_total_non <- 0  five_total_non <- 0  week_no <- week_no + 1  }countweek_nohead(weekly_total)weekly_totalclass(weekly_total)tail(weekly_total)############################################################################################ start generating efficiency, etc #############################################################################################################weekly_total$total_hours <- trunc(weekly_total$seven_minutes_cha / 60)   #total hours per week (ie 7 days) rather than minutesweekly_totalweekly_total$week_day_hours <- trunc(weekly_total$five_minutes_cha / 60)  #total hours per WORKING week (ie 5 days) rather than minutesweekly_totalweekly_total$min_per_fee <- trunc(weekly_total$five_minutes_cha / weekly_total$week_day_fee) # productive minutes per day per fee earner (EXCL WEEKENDS)weekly_totalweekly_total$firm_efficiency <- trunc((100 * weekly_total$five_minutes_cha) / (weekly_total$five_minutes_cha + weekly_total$five_minutes_non)) # FIRM efficency as a percentage - productive time / total time.weekly_totalweekly_total$non_per_fee <- trunc(weekly_total$five_minutes_non / weekly_total$week_day_fee) # NON-productive minutes per day per fee earner (EXCL WEEKENDS)weekly_totalweekly_total$ind_efficiency <- trunc (weekly_total$five_minutes_cha / weekly_total$week_day_fee) #efficiency per individual - lets go for productive time per fee earner. Not a true percentage but a good metric??weekly_total############################################################################################# get rid of the row with no data  #############################################################################################################temp_data <- weekly_total[-c(1:4),]cleaned_data <- temp_data[-c(730:750),]cleaned_datatail (cleaned_data)tail (temp_data, 20)######################################################################################### Now plot the data after weekly totals     ################################################################################################ggplot (data <- cleaned_data, aes(x = date, y=seven_minutes_cha, group = 1)) +     geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Weekly time - mintues")+  ggtitle("Total Recorded, Chargeable, Time by All Fee-Earners - over 7 day full week")## just the working weekggplot (data <- cleaned_data, aes(x = date, y=five_minutes_cha, group = 1)) +     geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Weekly time - minutes")+  ggtitle("Total Recorded, Chargeable, Time by All Fee-Earners - over 5 day working week")ggplot (data <- cleaned_data, aes(x = date, y=week_day_fee, group = 1)) +     geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Number of Fee Earners")+  ggtitle("Average number of Fee Earners per Week - Monday to Friday")  ggplot (data <- cleaned_data, aes(x = date, y=ind_efficiency, group = 1)) +     geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Productivity - productive minutes per fee earner")+  ggtitle("Productivity per fee earner", subtitle = "Total chargeable minutes divided by average number of Fee Earners")+  geom_smooth(method = "lm")ggplot (data <- cleaned_data, aes(x = date, y=week_end_fee, group = 1)) +     geom_point()+  xlab("Date - 2006 to March 2020")+  ylab("Number of Fee Earners")+  ggtitle("Average number of Fee Earners per Weekend - Saturday and Sunday")############################################################################### Now use Fpp2 to look at the time series ################################################################################ declare as time series datacleaned_datacleaned_data [,7]   #week_day_feecleaned_data [,9]   #total_hourscleaned_data [,11]  #ind_efficiencyY_no_fee <- ts (cleaned_data [,7], start = c(2006,7), frequency = 52)autoplot (Y_no_fee) +  ggtitle ("No. of fee earners per day 2006 - 2019") +  ylab ("No. of fee earners")Y_total_hours <- ts (cleaned_data[,9], start = c(2006,7), frequency = 52)autoplot (Y_total_hours) +  ggtitle ("Total number of hours 2006 - 2019") +  ylab ("No. of hours")Y_efficiency <- ts (cleaned_data[,11], start = c(2006,7), frequency = 52)autoplot (Y_efficiency) +  ggtitle ("Productivity 2006 - 2020") +  ylab ("Productivity - minutes per fee earner") +  xlab ("Date") ######################################################################################### smooth the data to make it easer to look at ################################################################################################Y_filtered <- stats::filter (Y_efficiency, sides = 1, filter = rep(1,3, circular = TRUE))#wgts <- c(0.5, rep(1,11), 0.5)/12#Y_filtered <- stats::filter(Y_efficiency, sides = 2, filter = wgts)#plot(Y_efficiency)#lines(Y_filtered, lwd = 2, col = 4)#par(fig = c(0.65, 1, 0.65, 1), new = TRUE)#nwgts = c (rep(0,20), wgts, rep(0,20))#plot (nwgts, type = "l", ylim = c(-0.02, 0.1), xaxt = 'n', yaxt = 'n', ann = FALSE)######################################################################################## season plot - is there anything in the years ###########################################################################################ggseasonplot(Y_efficiency, year.labels = TRUE, year.labels.left = TRUE)######################################################################################## split the data to get it down to some years  ############################################################################################cleaned_datacleaned_2007 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2007-01-01"),as.Date("2007-12-31")))cleaned_2007cleaned_2008 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2008-01-01"),as.Date("2008-12-31")))cleaned_2008cleaned_2009 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2009-01-01"),as.Date("2009-12-31")))cleaned_2009cleaned_2010 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2010-01-01"),as.Date("2010-12-31")))cleaned_2010cleaned_2011 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2011-01-01"),as.Date("2011-12-31")))cleaned_2011cleaned_2012 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2012-01-01"),as.Date("2012-12-31")))cleaned_2012cleaned_2013 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2013-01-01"),as.Date("2013-12-31")))cleaned_2013cleaned_2014 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2014-01-01"),as.Date("2014-12-31")))cleaned_2014cleaned_2015 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2015-01-01"),as.Date("2015-12-31")))cleaned_2015cleaned_2016 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2016-01-01"),as.Date("2016-12-31")))cleaned_2016cleaned_2017 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2017-01-01"),as.Date("2017-12-31")))cleaned_2017cleaned_2018 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2018-01-01"),as.Date("2018-12-31")))cleaned_2018cleaned_2019 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2019-01-01"),as.Date("2019-12-31")))cleaned_2019cleaned_2020 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2020-01-01"),as.Date("2020-12-31")))cleaned_2020ggplot (data <- cleaned_2007, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2008, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2009, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2010, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2011, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2012, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2013, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2014, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2015, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2016, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2017, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2018, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2019, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_2020, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")ggplot (data <- cleaned_data, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")##################################################################################### Rather than individual years - let's go for a decade #################################################################################cleaned_decade <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2010-01-01"), as.Date("2020-12-31")))cleaned_decadeggplot (data <- cleaned_decade, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm") +  xlab("Date - 2010 to March 2020")+  ylab("Productivity - minutes per fee earner")+  ggtitle("Productivity on per individual basis 2010 - 2020", subtitle = "With linear model highlighted to see overall trend")## so in the above, why is there a negative trend for most years but upward overall? Simpson's paradox?cleaned_half_decade <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2013-01-01"),as.Date("2017-12-31")))cleaned_half_decadeggplot (data <- cleaned_half_decade, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")################################################################################### split the data to get it down to some years - time series ##########################################################################cleaned_decade #2nd column is 'ind_efficiency'; ie the productivity that we are afterdecade_efficiency_ts <- ts (cleaned_decade[,2], start = c(2010,1), frequency = 52)autoplot (decade_efficiency_ts) +  ggtitle ("Productivity 2010 - 2020") +  ylab ("Productivity - minutes per fee earner")ggseasonplot(decade_efficiency_ts, year.labels = TRUE, year.labels.left = TRUE)+  ggtitle ("Seasonal plot - for years 2010 to 2020") +  ylab("Productivity - minutes per fee earner") +  xlab("Week - week no.")half_decade_ts <- ts(cleaned_half_decade[,2], start = c(2013,1), frequency = 52)autoplot (half_decade_ts) +  ggtitle ("Efficiency 2010 - 2020") +  ylab ("Efficiency %")ggseasonplot(half_decade_ts, year.labels = TRUE, year.labels.left = TRUE)#################################################################################### can we see why there is a peak in January / dip in December ##########################################################################cleaned_datatail (cleaned_data)cleaned_decade <- cleaned_data%>%  select(date, ind_efficiency, week_day_fee, five_minutes_cha) %>%  filter(between(date, as.Date("2010-01-01"), as.Date("2020-12-31")))cleaned_decadeggplot (data <- cleaned_decade, aes(x = date, y=ind_efficiency, group = 1)) +   #total hours is total weekly minutes (productive) divided by 60  geom_point()+  xlab("Date - Jan 2010 to March 2020")+  ylab("Productivity - Productive minutes, per week, per fee earner")+  ggtitle("Productivity 2010 - 2020 - Productive time per fee earner (weekly)")#Convert to a time seriescleaned_decade[,2]total_hours_ts <- ts (cleaned_decade[,2], start =c(2010,1), frequency = 52)  #time series for weekly totalsggseasonplot(total_hours_ts, year.labels = TRUE, year.labels.left = TRUE)+  ggtitle ("Seasonal plot - for years 2010 to 2020", subtitle = "total weekly productive time") +  ylab("Productivity - weekly minutes, per week, fee earner average") +  xlab("Week - week no.")#### What about the denominatior - number of fee earners??cleaned_decade[,3]week_day_fee_earner_ts <- ts (cleaned_decade [,3], start = c(2010,1), frequency = 52) # time series for fee eanersggseasonplot(week_day_fee_earner_ts, year.labels = TRUE, year.labels.left = TRUE)+  ggtitle ("Seasonal plot - for years 2010 to 2020", subtitle = "Average number of fee eaners per week (Mon to Friday)") +  ylab("Total number of fee eaners") +  xlab("Week - week no.")#### what about the numerator - number of hours?cleaned_decade[,4]five_minutes_cha_ts <- ts (cleaned_decade [,4], start = c(2010,1), frequency = 52) #time series for hoursggseasonplot(five_minutes_cha_ts, year.labels = TRUE, year.labels.left = TRUE)+  ggtitle ("Seasonal plot - for years 2010 to 2020", subtitle = "Weekly productive time") +  ylab("Total time charged (minutes)") +  xlab("Week - week no.")########################################################################### Note that even in decade, there is too much data to see a pattern #####################                      More is not always better                                      #####################     Let's get down to years 2012 to 2018 - 3 yrs each side             ######################################################################seven_years <- cleaned_data%>%  filter(between(date, as.Date("2012-01-01"), as.Date("2018-12-31")))seven_yearsggplot (data <- seven_years, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm") +  xlab("Date - 2012 to 2018")+  ylab("Productivity - minutes per fee earner")+  ggtitle("Productivity on per individual basis 2012 - 2018", subtitle = "With linear model highlighted to see overall trend")seven_years[,11]seven_years_ts <- ts (seven_years[,11], start =c(2012,1), frequency = 52)  #time series for productivity  2012 - 2018ggseasonplot(seven_years_ts, year.labels = TRUE, year.labels.left = TRUE)+  ggtitle ("Seasonal plot - for years 2012 to 2018", subtitle = "Productivity - total productive per fee earner") +  ylab("Productivity - productive hours per fee earner") +  xlab("Week - week no.")############################################################################################ Plot the productivity over the 7 years  #################################################################################################cleaned_2012 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2012-01-01"),as.Date("2012-12-31")))cleaned_2012cleaned_2013 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2013-01-01"),as.Date("2013-12-31")))cleaned_2013cleaned_2014 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2014-01-01"),as.Date("2014-12-31")))cleaned_2014cleaned_2015 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2015-01-01"),as.Date("2015-12-31")))cleaned_2015cleaned_2016 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2016-01-01"),as.Date("2016-12-31")))cleaned_2016cleaned_2017 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2017-01-01"),as.Date("2017-12-31")))cleaned_2017cleaned_2018 <- cleaned_data%>%  select(date, ind_efficiency)%>%  filter(between(date, as.Date("2018-01-01"),as.Date("2018-12-31")))cleaned_2018ggplot (data <- cleaned_2012, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm") +   ggtitle ("Productivity - Productive time per fee earner 2012") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2013, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2013") +  xlab("Date") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2014, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2014") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2015, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2015") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2016, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2016") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2017, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2017") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")ggplot (data <- cleaned_2018, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")+   ggtitle ("Productivity - Productive time per fee earner 2018") +  xlab("Week - week no.") +  ylab("Productivity - productive hourse per fee earner")seven_years### Let's add the individual years back together to see if we get back to where we started??cleaned_rejoined <- rbind(cleaned_2012, cleaned_2013, cleaned_2014, cleaned_2015, cleaned_2016, cleaned_2017, cleaned_2018)ggplot (data <- cleaned_rejoined, aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")cleaned_2012_to_2013 <- rbind(cleaned_2012, cleaned_2013)ggplot (data <- cleaned_2012_to_2013 , aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")cleaned_2014_to_2016 <- rbind(cleaned_2014, cleaned_2015, cleaned_2016)ggplot (data <- cleaned_2014_to_2016 , aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")summary (cleaned_2012)summary (cleaned_2013)summary (cleaned_2014)summary (cleaned_2015)summary (cleaned_2016)summary (cleaned_2017)summary (cleaned_2018)################################################################################ Looks like a classic case of Simpson's paradox    #####################################           try to plot scatter plot                             #####################################     with a different colour for each year           #########################################################################################cleaned_decadeggplot (data <- cleaned_decade , aes(x=date, y=ind_efficiency, group = 1)) +  geom_point()cleaned_decade$year <- year(cleaned_decade$date)cleaned_decadeggplot (data <- cleaned_decade , aes(x=date, y=ind_efficiency, colour = year)) +  geom_point()cleaned_decade$week_no <- isoweek(cleaned_decade$date)cleaned_decadeggplot (data <- cleaned_decade , aes(x=week_no, y=ind_efficiency, colour = year)) +  geom_point()+  scale_color_viridis(option = "D") +  ggtitle ("Productivity - Productive minutes per week per average daily fee earner") +  xlab ("Week number (ISO)") +  ylab ("Productivity - minutes per fee earner")#### let's just select 2010 and 2020 to make it much clearersimpsons_paradox <- cleaned_decade%>%  filter(cleaned_decade$year == 2010 | cleaned_decade$year == 2019)simpsons_paradoxggplot (data <- simpsons_paradox , aes(x=week_no, y=ind_efficiency, color = year)) +  geom_point()+  ggtitle ("Productivity - Productive minutes per week per average daily fee earner") +  xlab ("Week number (ISO)") +  ylab ("Productivity - minutes per fee earner") #######################################################################################.           Let's try and fit multiple linear models to                #####################################                          underlying scatter plot                             ##################################################################################################cleaned_decadecleaned_decade$before <- cleaned_decade$year < 2015ggplot (data <- cleaned_decade, aes(x = date, y=ind_efficiency, group = before)) +   #total hours is total weekly minutes (productive) divided by 60  geom_point() +  stat_smooth(method = "lm") +  ylab("Productivity - Productive minutes, per week, per fee earner") +  xlab("Date - Jan 2010 to March 2020") +  ggtitle("Productivity 2010 - 2020 - Productive time per fee earner (weekly)")    cleaned_decadetail(cleaned_decade)##################################################################################        Let's try and fit multiple linear models to       #####################################                      underlying scatter plot                   #####################################                   now years 2014 Ð 2016           ####################################################################################################cleaned_2014_to_2016 <- rbind(cleaned_2014, cleaned_2015, cleaned_2016)cleaned_2014_to_2016 <- cleaned_decade%>%  filter(cleaned_decade$year == 2014 | cleaned_decade$year == 2015)ggplot (data <- cleaned_2014_to_2016 , aes(x=date, y=ind_efficiency, group = 1)) +  geom_point() +  geom_smooth(method = "lm")head(cleaned_2014_to_2016)tail(cleaned_2014_to_2016)cleaned_2014_to_2016$before <- cleaned_2014_to_2016$year < 2015ggplot (data <- cleaned_2014_to_2016, aes(x = date, y=ind_efficiency, group = before)) +   #total hours is total weekly minutes (productive) divided by 60  geom_point() +  stat_smooth(method = "lm") +  ylab("Productivity - Productive minutes, per week, per fee earner") +  xlab("Date - Jan 2014 to December 2016") +  ggtitle("Productivity 2014 - 2016 - Productive time per fee earner (weekly)")       cleaned_decadetail(cleaned_decade)1Student ID: 0860990